# Copyright (c) 2022 Arista Networks, Inc.  All rights reserved.
# Arista Networks, Inc. Confidential and Proprietary.

images:
  # as we product .pyc and txt we do not have dyn linking,
  # there is no pressure on glibc / musl
  mfw_pkg/support-diagnostics:
    units:
      - floor: code.arista.io/efw/build%toolchain
        entry:
          mutables:
            - /mfw-toolchain # required as we link instead of copy
        sources:
          - code.arista.io/efw/build
          - code.arista.io/efw/openwrt
          - code.arista.io/efw/mfw_feeds
        mappings:
          /src/github.com/untangle/support-diagnostics:
            snapshot: code.arista.io/efw/support-diagnostics
            mutable: true
        quota:
          memory: 4Gi
          cpu: 3.5
        build: |
          set -ex

          # link build%toolchain's staging_dir into our source tree
          # we used to copy here, but we link to reduce memory footprint
          ln -s /mfw-toolchain/staging_dir /src/code.arista.io/efw/openwrt/staging_dir

          # use barney-supplied feeds instead of fetching from github
          perl -i -pe 's|^src-git mfw .+|src-link mfw /src/code.arista.io/efw/mfw_feeds|' /src/code.arista.io/efw/build/feeds.conf.mfw

          # barney sets DESTDIR to /dest, but this really confuses openwrt
          unset DESTDIR

          # build our package
          cd /src/code.arista.io/efw/openwrt
          /src/code.arista.io/efw/build/build.sh -f /src -t "package/feeds/packages/python3/host/compile package/feeds/mfw/support-diagnostics/compile"

          # copy resulting packages to destination image
          mkdir -p /dest/mfw-packages/support-diagnostics
          cp bin/packages/x86_64/*/* /dest/mfw-packages/support-diagnostics
          cp bin/targets/x86/64/packages/* /dest/mfw-packages/support-diagnostics

  test/mfw_pkg/support-diagnostics:
    units:
      - floor: code.arista.io/efw/build%world
        sources: []
        mappings:
          /src/support-diagnostics:
            snapshot: .%mfw_pkg/support-diagnostics
            mutable: false
        build: |
          mkdir /var/lock
          opkg install --force-downgrade /src/support-diagnostics/mfw-packages/*/*

          ls /usr/bin/support-diagnostics
          file support-diagnostics | grep "Python script"

  ################
  #
  # Validate non-code files
  #
  #########

  tests/internal/renovate-json5-floor:
    units:
      - image: barney.ci/debian%network
      - image: barney.ci/debian%pkg/node-json5

  tests/renovate-json5:
    units:
      - floor: .%tests/internal/renovate-json5-floor
        sources:
          - code.arista.io/efw/support-diagnostics # to get sources under stable path
        quota:
          memory: 500Mi
          cpu: 1
        build: |
          json5 --validate /src/code.arista.io/efw/support-diagnostics/renovate.json5
